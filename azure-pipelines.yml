trigger:
  batch: true

name: $(BuildID)

variables:
  - group: keyvault-image-build-variables
  - group: packer-image-build-variables
  
stages:
- stage: win10_21h1_evd_o365pp
  displayName: Windows 10 O365 Pro Plus
  jobs:
  - job: build
    displayName: Build Image
    pool:
      name: <nombre del pool de agentes>
      demands:
        - agent.name -equals <nombre del agente> 
    steps:
    - task: PowerShell@2
      displayName: "Mount azure file share to Z"
      inputs:
        targetType: 'inline'
        script: |
          net use * /delete /y
          $connectTestResult = Test-NetConnection -ComputerName $(StorageAccountName).file.core.windows.net -Port 445
          if ($connectTestResult.TcpTestSucceeded) {
          cmd.exe /C "cmdkey /add:`"$(StorageAccountName).file.core.windows.net`" /user:`"Azure\$(StorageAccountName)`" /pass:`"$(StorageAccountKey)`""
          New-PSDrive -Name Z -PSProvider FileSystem -Root "\\$(StorageAccountName).file.core.windows.net\installers" -Persist
          } 
    - task: riezebosch.Packer.PackerTool.PackerTool@0
      displayName: 'Use Packer 1.7.2'
      inputs:
        version: 1.7.2
    - task: PackerBuild@1
      displayName: 'Build Image'
      inputs:
          templateType: custom
          customTemplateLocation: 'packer.json'
          customTemplateParameters: '{"ADOServicePrincipalAppId":"$(ADOAppID)","ADOServicePrincipalSecret":"$(ADOAppSecret)","TenantId":"$(TenantId)","SubscriptionId":"$(SubscriptionId)","ImageDestRG":"$(ImageDestRG)","TempResourceGroup":"$(TempResourceGroup)","VirtualNetwork":"$(VirtualNetwork)","VirtualNetworkRG":"$(VirtualNetworkRG)","Subnet":"$(Subnet)","Location":"$(Location)","VMSize":"$(VMSize)","StorageAccountInstallersName":"$(StorageAccountName)","StorageAccountInstallersKey":"$(StorageAccountKey)","StorageAccountInstallersPath":"$(StorageAccountInstallersPath)"}'
          imageUri: BuildImage
    - task: nkdagility.variablehydration.variabledehydration-task.variabledehydration@0
      displayName: 'Save Build Variables: BuildImage'
      inputs:
        prefixes: BuildImage
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: Build Image and associated Template'
      inputs:
        ArtifactName: 'Build Image'
    - task: PowerShell@2
      displayName: "Dismount any mapped network drive"
      inputs:
        targetType: 'inline'
        script: |
              net use * /delete /y
